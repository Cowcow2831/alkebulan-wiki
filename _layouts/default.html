<!DOCTYPE html>
<!-- _layouts/default.html with Dynamic View Toggle -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="baseurl" content="{{ site.baseurl }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if page.title %}{{ page.title }} | {% endif %}{{ site.title }}</title>
    <meta name="description" content="{{ page.excerpt | default: site.description | strip_html | normalize_whitespace | truncate: 160 | escape }}">
    {% if page.access_level %}
    <meta name="page-access-level" content="{{ page.access_level }}">
    {% endif %}

    <!-- SEO -->
    {% seo %}

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ site.baseurl }}/assets/favicon.ico">

    <!-- Navigation Data -->
    <!-- <script src="{{ site.baseurl }}/assets/js/navigation.js"></script> -->

    <!-- Styles -->
    <link rel="stylesheet" href="{{ site.baseurl }}/assets/css/styles.css">
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>
    <header>
        <div class="container">
          <div class="header-content" id="headerContent">
              <!-- Desktop: Title and Search on first line -->
              <div class="title-search-line">
                  <div class="title-line">
                      <a href="{{ site.baseurl }}/" class="site-title">{{ site.title }}</a>
                  </div>
                  <div class="search-line">
                      <div class="search-container">
                          <input type="text" id="searchBox" placeholder="üîç Search archives..." class="search-input">
                          <div id="searchResults" class="search-results"></div>
                      </div>
                  </div>
              </div>

              <!-- Desktop: Access controls and Nav on second line (when wrapped) -->
              <div class="access-nav-line">
                  <div class="access-line">
                      <span class="view-mode-indicator view-mode-player" id="viewIndicator">PLAYER VIEW</span>
                      <button class="view-toggle player-mode" id="viewToggle" onclick="toggleView()">
                          üîì DM ACCESS
                      </button>
                  </div>

                  <div class="nav-line">
                      <nav>
                          <ul>
                              {% for item in site.navigation %}
                              <li><a href="{{ site.baseurl }}{{ item.url }}" class="nav-item" data-access="{{ item.access_level | default: 'public' }}">{{ item.title }}</a></li>
                              {% endfor %}
                          </ul>
                      </nav>
                  </div>
              </div>
          </div>
        </div>
    </header>

    <main>
      <main id="main-content">
        <div class="container">
            <div class="content-wrapper">
                <article class="main-content">
                    {% if page.title %}
                    <h1 class="page-title">{{ page.title }}</h1>
                    {% endif %}

                    <div id="content">
                        <div class="classified-banner-container" id="classifiedBanner" style="display: none;">
                            <div class="classified-banner">
                                <h2>‚ö†Ô∏è CLASSIFIED ‚ö†Ô∏è</h2>
                                <p>This content requires DM level access.</p>
                                <p style="font-size: 0.9rem; opacity: 0.9;">Contact your local Remnant Keepers for authorization.</p>
                            </div>
                        </div>

                        <div id="actualContent">
                            {{ content }}
                        </div>
                    </div>
                </article>

                <aside class="sidebar">
                    <div class="nav-section">
                        <h4>üß≠ Navigation</h4>

                        <div class="nav-level">
                            <div class="nav-level-title">Quick Access</div>
                            <a href="{{ site.baseurl }}/" class="nav-item nav-home">Archive Home</a>
                            <div id="recentPages">
                                <!-- Recent pages will be populated by JavaScript -->
                            </div>
                        </div>

                        <div class="nav-level" id="navUp" style="display: none;">
                            <div class="nav-level-title">Up One Level</div>
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    <div class="nav-section">
                        <h4>üìÑ Page Tools</h4>
                        <div class="nav-level">
                            <div class="nav-level-title">Export Options</div>
<button onclick="downloadAsMarkdown()" class="download-btn nav-item" style="width: 100%; text-align: left; border: none; cursor: pointer;">
                                üì• Download as .md
                            </button>
                        </div>
                    </div>
                    <div class="contamination-warning">
                        <strong>‚ö†Ô∏è WARNING</strong><br>
                        This archive contains<br>
                        <em>Remnant Magic traces</em><br>
                        Access with caution
                    </div>
                </aside>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 {{ site.author | default: site.title }}. Classified Archive System for {{ site.campaign | default: "Contaminated Research" }}.</p>
        </div>
    </footer>

    <script>
        // View toggle functionality
        let currentView = 'player'; // Default to player view
        let originalContent = ''; // Store original content

        function toggleView() {
            if (currentView === 'dm') {
                // Switch to player view
                switchToPlayerView();
            } else {
                // Attempt to switch to DM view (requires password)
                promptForDMAccess();
            }
        }

        function promptForDMAccess() {
            const password = prompt("üîí DM ACCESS REQUIRED\n\nEnter the contamination clearance code:");

            if (password === null) {
                return; // User cancelled
            }

            // Check password using hash comparison (more secure)
            const validHashes = [
              "74103542",
              "c89",
              "1abd1052"
            ];

            // Simple hash function
            function simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return Math.abs(hash).toString(16);
            }

            if (validHashes.includes(simpleHash(password)))
            {
                switchToDMView();

                // Store DM access temporarily (until page refresh)
                sessionStorage.setItem('dmAccess', 'granted');
            } else {
                alert("üö´ ACCESS DENIED\n\nInvalid contamination clearance code.\nContact your Remnant Keeper for proper authorization.");
            }
        }

        function switchToDMView() {
            const toggle = document.getElementById('viewToggle');
            const indicator = document.getElementById('viewIndicator');
            const body = document.body;

            currentView = 'dm';
            toggle.textContent = 'üîÑ SWITCH TO PLAYER VIEW';
            toggle.className = 'view-toggle dm-mode';
            indicator.textContent = 'DM VIEW';
            indicator.className = 'view-mode-indicator view-mode-dm';
            body.className = 'dm-view';

            // Show all content with DM highlighting
            filterContent('dm');
            hideNavItems('dm');

            // Save preference
            localStorage.setItem('wikiView', currentView);
            sessionStorage.setItem('dmAccess', 'granted');
        }

        function switchToPlayerView() {
            const toggle = document.getElementById('viewToggle');
            const indicator = document.getElementById('viewIndicator');
            const body = document.body;

            currentView = 'player';
            toggle.textContent = 'üîì DM ACCESS';
            toggle.className = 'view-toggle player-mode';
            indicator.textContent = 'PLAYER VIEW';
            indicator.className = 'view-mode-indicator view-mode-player';
            body.className = 'player-view';

            // Hide DM-only content
            filterContent('player');
            hideNavItems('player');

            // Clear DM session access
            sessionStorage.removeItem('dmAccess');

            // Save preference
            localStorage.setItem('wikiView', currentView);
        }

        function filterContent(viewMode) {
            const content = document.getElementById('content');
            const classifiedBanner = document.getElementById('classifiedBanner');
            const actualContent = document.getElementById('actualContent');

            if (!originalContent) {
                originalContent = content.innerHTML; // Store original on first run
            }

            // Check if this page requires DM access
            const pageAccessLevel = document.querySelector('meta[name="page-access-level"]')?.getAttribute('content');

            if (viewMode === 'player' && pageAccessLevel === 'dm') {
                // Show classified banner and hide actual content for DM-only pages
                classifiedBanner.style.display = 'block';
                actualContent.style.display = 'none';
                return;
            } else {
                // Hide classified banner and show content
                classifiedBanner.style.display = 'none';
                actualContent.style.display = 'block';
            }

            let html = originalContent;

            if (viewMode === 'player') {
                // Remove DM-only sections completely
                html = html.replace(/<!-- DM_START -->([\s\S]*?)<!-- DM_END -->/g, '');

                // Remove player-safe markers but keep the content
                html = html.replace(/<!-- PLAYER_SAFE_START -->/g, '');
                html = html.replace(/<!-- PLAYER_SAFE_END -->/g, '');

                content.innerHTML = html;
            } else {
                // DM view - highlight only DM sections, leave player content normal
                html = html.replace(/<!-- DM_START -->/g, '<div class="dm-only" style="border-left: 4px solid var(--danger-red); padding-left: 1rem; background: rgba(255, 51, 51, 0.1); margin: 1rem 0; border-radius: 0 6px 6px 0;"><strong style="color: var(--danger-red); font-size: 0.9rem;">üîí DM ONLY:</strong><br>');
                html = html.replace(/<!-- DM_END -->/g, '</div>');

                // Remove player-safe markers but don't highlight
                html = html.replace(/<!-- PLAYER_SAFE_START -->/g, '');
                html = html.replace(/<!-- PLAYER_SAFE_END -->/g, '');

                content.innerHTML = html;
            }
        }

        function hideNavItems(viewMode) {
            const navItems = document.querySelectorAll('.nav-item');

            navItems.forEach(item => {
                const accessLevel = item.getAttribute('data-access');

                if (viewMode === 'player' && accessLevel === 'dm') {
                    item.style.display = 'none';
                } else {
                    item.style.display = 'block';
                }
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Store original content before any modifications
            originalContent = document.getElementById('content').innerHTML;

            // Check for saved DM session access
            const hasSessionAccess = sessionStorage.getItem('dmAccess') === 'granted';
            const savedView = localStorage.getItem('wikiView');

            // If user had DM access in this session and saved preference is DM, restore it
            if (hasSessionAccess || savedView === 'dm') {
                // Auto-restore DM view
                currentView = 'dm';
                switchToDMView();
            } else {
                // Default to player view
                currentView = 'player';
                switchToPlayerView();
            }

            // Setup simple navigation
            setupSimpleNavigation();

            // Initialize accessibility controls
            initAccessibilityPreferences();
        });

        // Backup initialization in case DOM is already loaded
        if (document.readyState === 'loading') {
            // DOM is still loading, event listener will handle it
        } else {
            // DOM already loaded, run immediately
            setTimeout(initAccessibilityPreferences, 100);
        }

        // Simplified navigation system
        function setupSimpleNavigation() {
            try {
                const currentPath = window.location.pathname;
                const pathParts = currentPath.split('/').filter(part => part);
                const currentPage = pathParts[pathParts.length - 1] || 'index';

                // Track and display recent pages
                trackRecentPages(currentPage);
                displayRecentPages();
            } catch (error) {
                console.error('Error in setupSimpleNavigation:', error);
            }
        }

        // Track recent pages (last 2 visited)
        function trackRecentPages(currentPage) {
            try {
                let recentPages = JSON.parse(localStorage.getItem('wikiRecentPages')) || [];

                // Remove current page if it's already in the list
                recentPages = recentPages.filter(page => page.slug !== currentPage);

                // Add current page to the beginning
                const pageTitle = getPageTitle(currentPage);
                recentPages.unshift({
                    slug: currentPage,
                    title: pageTitle,
                    timestamp: Date.now()
                });

                // Keep only the last 3 pages (current + 2 previous)
                recentPages = recentPages.slice(0, 3);

                // Save to localStorage
                localStorage.setItem('wikiRecentPages', JSON.stringify(recentPages));
            } catch (error) {
                console.error('Error tracking recent pages:', error);
            }
        }

        // Display recent pages in the sidebar
        function displayRecentPages() {
            try {
                const recentPagesContainer = document.getElementById('recentPages');
                if (!recentPagesContainer) return;

                const recentPages = JSON.parse(localStorage.getItem('wikiRecentPages')) || [];

                // Skip the first page (current page) and show the last 2
                const pagesToShow = recentPages.slice(1, 3);

                if (pagesToShow.length === 0) {
                    recentPagesContainer.innerHTML = '<div style="font-size: 0.8rem; color: var(--text-muted); font-style: italic;">No recent pages</div>';
                    return;
                }

                let html = '';
                pagesToShow.forEach(page => {
                    const url = page.slug === 'index' ? '{{ site.baseurl }}/' : '{{ site.baseurl }}/' + page.slug + '/';
                    html += '<a href="' + url + '" class="nav-item nav-recent">üìÑ ' + escapeHtml(page.title) + '</a>';
                });

                recentPagesContainer.innerHTML = html;
            } catch (error) {
                console.error('Error displaying recent pages:', error);
            }
        }

        // Get page title based on slug
        function getPageTitle(slug) {
            const pageTitles = {
                'index': 'Archive Home',
                'port-zephyr': 'Port Zephyr',
                'player-handout-whispers-of-the-wastes': 'Player Handout'
            };

            return pageTitles[slug] || slug.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Header scroll behavior - mobile only, minimize only, don't hide
                let lastScrollTop = 0;
                let scrollThreshold = 80; // Pixels to scroll before minimizing
                let isMinimal = false;

                function handleHeaderScroll() {
                    // Only apply scroll behavior on mobile (768px and below)
                    if (window.innerWidth > 768) {
                        // On desktop, always keep full header
                        const header = document.querySelector('header');
                        header.classList.remove('header-minimal');
                        isMinimal = false;
                        return;
                    }

                    const header = document.querySelector('header');
                    const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const scrollDirection = currentScrollTop > lastScrollTop ? 'down' : 'up';

                    // If at the top, always show full header
                    if (currentScrollTop <= 10) {
                        header.classList.remove('header-minimal');
                        isMinimal = false;
                        lastScrollTop = currentScrollTop;
                        return;
                    }

                    // If scrolling down past threshold and not already minimal, minimize
                    if (scrollDirection === 'down' && currentScrollTop > scrollThreshold && !isMinimal) {
                        header.classList.add('header-minimal');
                        isMinimal = true;
                    }
                    // If scrolling up significantly, restore full header
                    else if (scrollDirection === 'up' && isMinimal) {
                        // Calculate how much we've scrolled up
                        const scrollUpAmount = lastScrollTop - currentScrollTop;

                        // If we've scrolled up at least 50px, restore full header
                        if (scrollUpAmount > 50) {
                            header.classList.remove('header-minimal');
                            isMinimal = false;
                        }
                    }

                    lastScrollTop = currentScrollTop <= 0 ? 0 : currentScrollTop;
                }

                // Handle window resize to reset header state
                        function handleWindowResize() {
                            const header = document.querySelector('header');
                            if (window.innerWidth > 768) {
                                // On desktop, always remove minimal class
                                header.classList.remove('header-minimal');
                                isMinimal = false;
                            }
                        }

                        // Handle window resize to reset header state
                        function handleWindowResize() {
                            const header = document.querySelector('header');
                            if (window.innerWidth > 768) {
                                // On desktop, always remove minimal class
                                header.classList.remove('header-minimal');
                                isMinimal = false;
                            }
                        }

                        // Add resize listener
                        window.addEventListener('resize', handleWindowResize);

        // Throttle scroll events for better performance
        let scrollTimeout;
        function throttledScrollHandler() {
            if (scrollTimeout) {
                return;
            }
            scrollTimeout = setTimeout(function() {
                handleHeaderScroll();
                scrollTimeout = null;
            }, 10);
        }

        // Add scroll listener
        window.addEventListener('scroll', throttledScrollHandler);
        // Search functionality
        let searchData = [];
        let searchTimeout;

        // Load search data
        let searchDataLoaded = false;

        function loadSearchData() {
            const searchUrl = '{{ site.baseurl }}/search.json';
            console.log('Loading search data from:', searchUrl); // Debug log

            fetch(searchUrl)
                .then(response => {
                    console.log('Search response status:', response.status); // Debug log
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Search data loaded:', data.length, 'items'); // Debug log
                    searchData = data;
                    searchDataLoaded = true;
                })
                .catch(error => {
                    console.error('Search data loading failed:', error);
                    // Fallback: create basic search data from current page
                    searchData = [{
                        title: document.title,
                        url: window.location.pathname,
                        content: document.querySelector('.main-content') ?
                            document.querySelector('.main-content').textContent.substring(0, 200) : '',
                        access_level: 'public'
                    }];
                    searchDataLoaded = true;
                });
        }

        // Load search data when page loads
        document.addEventListener('DOMContentLoaded', loadSearchData);

        // Search input handler
        document.addEventListener('DOMContentLoaded', function() {
            const searchBox = document.getElementById('searchBox');
            const searchResults = document.getElementById('searchResults');

            if (searchBox) {
                searchBox.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => performSearch(this.value), 300);
                });

                // Hide results when clicking outside
                document.addEventListener('click', function(e) {
                    if (!searchBox.contains(e.target) && !searchResults.contains(e.target)) {
                        searchResults.style.display = 'none';
                    }
                });
            }
        });

        function performSearch(query) {
            const searchResults = document.getElementById('searchResults');

            if (query.length < 2) {
                searchResults.style.display = 'none';
                return;
            }

            if (!searchDataLoaded) {
                searchResults.innerHTML = '<div class="search-result-item">Search initializing...</div>';
                searchResults.style.display = 'block';
                return;
            }

            const queryLower = query.toLowerCase();
            const queryWords = queryLower.split(' ').filter(word => word.length > 1);

            // Score each item
            const scoredResults = searchData
                .filter(item => {
                    // Filter by current view mode first
                    if (currentView === 'player' && item.access_level === 'dm') {
                        return false;
                    }

                    // Basic relevance check - must match at least one word
                    const titleLower = item.title.toLowerCase();
                    const contentLower = item.content.toLowerCase();

                    return queryWords.some(word =>
                        titleLower.includes(word) || contentLower.includes(word)
                    );
                })
                .map(item => {
                    const titleLower = item.title.toLowerCase();
                    const contentLower = item.content.toLowerCase();
                    let score = 0;

                    queryWords.forEach(word => {
                        // Exact title match gets highest score
                        if (titleLower === word) {
                            score += 100;
                        }
                        // Title starts with query word
                        else if (titleLower.startsWith(word)) {
                            score += 50;
                        }
                        // Title contains word
                        else if (titleLower.includes(word)) {
                            score += 25;
                        }
                        // Content contains word
                        else if (contentLower.includes(word)) {
                            score += 5;
                        }

                        // Bonus for multiple word matches
                        const titleMatches = queryWords.filter(w => titleLower.includes(w)).length;
                        const contentMatches = queryWords.filter(w => contentLower.includes(w)).length;

                        if (titleMatches > 1) score += 20;
                        if (contentMatches > 1) score += 10;
                    });

                    // Bonus for shorter titles (more specific results)
                    if (item.title.length < 20) score += 5;

                    return { ...item, score };
                })
                // Sort by score (highest first)
                .sort((a, b) => b.score - a.score)
                .slice(0, 5); // Limit to top 5 results

            console.log('Search query:', query, 'Results:', scoredResults.length, 'scored results:', scoredResults.map(r => ({ title: r.title, score: r.score })));

            if (scoredResults.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">No results found for "' + query + '"</div>';
                searchResults.style.display = 'block';
                return;
            }

            searchResults.innerHTML = scoredResults.map((item, index) => `
                <div class="search-result-item" onclick="window.location.href='${item.url}'" data-score="${item.score}">
                    <div class="search-result-title">
                        ${highlightMatches(item.title, queryWords)}
                        <span class="search-result-rank">#${index + 1}</span>
                    </div>
                    <div class="search-result-content">${highlightMatches(item.content, queryWords)}</div>
                </div>
            `).join('');

            searchResults.style.display = 'block';
        }

        // Helper function to highlight matching words
        function highlightMatches(text, queryWords) {
            let highlighted = text;
            queryWords.forEach(word => {
                const regex = new RegExp(`(${word})`, 'gi');
                highlighted = highlighted.replace(regex, '<mark>$1</mark>');
            });
            return highlighted;
        }
        // Download current page as markdown
        function downloadAsMarkdown() {
            try {
                // Get page data
                const pageTitle = document.querySelector('.page-title')?.textContent?.replace('‚ò¢Ô∏è', '').trim() ||
                                 document.querySelector('h1')?.textContent ||
                                 'Untitled Page';

                // Get the main content without the classified banner
                const contentElement = document.getElementById('actualContent');
                if (!contentElement) {
                    alert('Unable to export page content.');
                    return;
                }

                // Clone the content to avoid modifying the original
                const contentClone = contentElement.cloneNode(true);

                // Remove any DM-only sections if in player view
                if (currentView === 'player') {
                    const dmSections = contentClone.querySelectorAll('.dm-only');
                    dmSections.forEach(section => section.remove());
                }

                // Convert HTML back to markdown-like format
                let markdownContent = htmlToMarkdown(contentClone);

                // Create frontmatter
                const currentUrl = window.location.pathname;
                const pageAccessLevel = document.querySelector('meta[name="page-access-level"]')?.getAttribute('content') || 'public';
                const currentDate = new Date().toISOString().split('T')[0];

                const frontmatter = `---
        title: "${pageTitle}"
        access_level: ${pageAccessLevel}
        exported_from: ${window.location.href}
        exported_date: ${currentDate}
        exported_view: ${currentView}
        ---

        `;

                // Combine frontmatter and content
                const fullContent = frontmatter + markdownContent;

                // Create and download file
                const blob = new Blob([fullContent], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');

                // Clean filename
                const filename = pageTitle.toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-')
                    .trim() + '.md';

                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                console.log(`Downloaded: ${filename}`);

            } catch (error) {
                console.error('Download error:', error);
                alert('Error downloading file. Please try again.');
            }
        }

        // Helper function to convert HTML back to markdown
        function htmlToMarkdown(element) {
            let markdown = '';
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_ALL,
                null,
                false
            );

            let node;
            while (node = walker.nextNode()) {
                switch (node.nodeType) {
                    case Node.TEXT_NODE:
                        markdown += node.textContent;
                        break;
                    case Node.ELEMENT_NODE:
                        switch (node.tagName.toLowerCase()) {
                            case 'h1':
                                markdown += '\n# ';
                                break;
                            case 'h2':
                                markdown += '\n## ';
                                break;
                            case 'h3':
                                markdown += '\n### ';
                                break;
                            case 'h4':
                                markdown += '\n#### ';
                                break;
                            case 'h5':
                                markdown += '\n##### ';
                                break;
                            case 'h6':
                                markdown += '\n###### ';
                                break;
                            case 'p':
                                markdown += '\n\n';
                                break;
                            case 'br':
                                markdown += '\n';
                                break;
                            case 'strong':
                            case 'b':
                                markdown += '**';
                                break;
                            case 'em':
                            case 'i':
                                markdown += '*';
                                break;
                            case 'ul':
                                markdown += '\n';
                                break;
                            case 'li':
                                markdown += '\n- ';
                                break;
                            case 'blockquote':
                                markdown += '\n> ';
                                break;
                            case 'code':
                                markdown += '`';
                                break;
                            case 'a':
                                const href = node.getAttribute('href');
                                if (href) {
                                    markdown += `[${node.textContent}](${href})`;
                                    walker.nextNode(); // Skip text content since we handled it
                                }
                                break;
                        }
                        break;
                }
            }

            // Clean up the markdown
            return markdown
                .replace(/\n{3,}/g, '\n\n') // Remove excessive newlines
                .trim();
        }
        // Enhanced Accessibility Control Panel
        function initAccessibilityPreferences() {
            // Create control panel container
            const controlPanel = document.createElement('div');
            controlPanel.className = 'accessibility-controls';
            controlPanel.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 2000;
                display: flex;
                flex-direction: column;
                gap: 8px;
                max-width: 200px;
            `;

            // Create safe mode toggle
            const safeModeToggle = document.createElement('button');
            safeModeToggle.className = 'accessibility-btn safe-mode-btn';
            safeModeToggle.textContent = 'üß† Migraine Mode';
            safeModeToggle.title = 'Toggle migraine-friendly viewing mode';

            // Create contrast toggle
            const contrastToggle = document.createElement('button');
            contrastToggle.className = 'accessibility-btn contrast-btn';
            contrastToggle.textContent = 'üìä Lower Contrast';
            contrastToggle.title = 'Reduce visual contrast';

            // Create status indicator
            const statusIndicator = document.createElement('div');
            statusIndicator.className = 'mode-status';
            statusIndicator.textContent = 'Normal Mode';

            // Add buttons to panel
            controlPanel.appendChild(statusIndicator);
            controlPanel.appendChild(safeModeToggle);
            controlPanel.appendChild(contrastToggle);
            document.body.appendChild(controlPanel);

            // Safe mode toggle function
            safeModeToggle.onclick = function() {
                const wasSafeMode = document.body.classList.contains('safe-mode');

                if (wasSafeMode) {
                    document.body.classList.remove('safe-mode');
                    localStorage.setItem('safeModeEnabled', 'false');
                } else {
                    document.body.classList.add('safe-mode');
                    localStorage.setItem('safeModeEnabled', 'true');
                }

                updateModeStatus();
            };

            // Contrast toggle function
            contrastToggle.onclick = function() {
                const wasLowContrast = document.body.classList.contains('low-contrast');

                if (wasLowContrast) {
                    document.body.classList.remove('low-contrast');
                    localStorage.setItem('lowContrastEnabled', 'false');
                } else {
                    document.body.classList.add('low-contrast');
                    localStorage.setItem('lowContrastEnabled', 'true');
                }

                updateModeStatus();
            };

            // Function to update status and button text
            function updateModeStatus() {
                const isSafeMode = document.body.classList.contains('safe-mode');
                const isLowContrast = document.body.classList.contains('low-contrast');

                // Update button text
                safeModeToggle.textContent = isSafeMode ? 'üé® Normal Mode' : 'üß† Migraine Mode';
                contrastToggle.textContent = isLowContrast ? 'üìä High Contrast' : 'üìä Lower Contrast';

                // Clear all previous status classes first
                statusIndicator.className = 'mode-status';

                // Update status indicator
                let statusText = 'Normal Mode';
                let statusClass = 'normal';

                if (isSafeMode && isLowContrast) {
                    statusText = 'Safe + Low Contrast';
                    statusClass = 'safe-low';
                } else if (isSafeMode) {
                    statusText = 'Migraine-Safe Mode';
                    statusClass = 'safe';
                } else if (isLowContrast) {
                    statusText = 'Low Contrast Mode';
                    statusClass = 'low-contrast';
                }

                statusIndicator.textContent = statusText;
                statusIndicator.className = `mode-status ${statusClass}`;

                // Force a reflow to ensure changes take effect
                statusIndicator.offsetHeight;
                controlPanel.offsetHeight;
            }

            // Check saved preferences on load
            const safeModeEnabled = localStorage.getItem('safeModeEnabled') === 'true';
            const lowContrastEnabled = localStorage.getItem('lowContrastEnabled') === 'true';

            if (safeModeEnabled) {
                document.body.classList.add('safe-mode');
            }
            if (lowContrastEnabled) {
                document.body.classList.add('low-contrast');
            }

            // Check for reduced motion preference
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.body.classList.add('reduced-motion');
            }

            // Initial status update
            updateModeStatus();
        }

        // Call this function when page loads
        document.addEventListener('DOMContentLoaded', initAccessibilityPreferences);


        // Debug function - add this temporarily
        function debugContrastMode() {
            const isLowContrast = document.body.classList.contains('low-contrast');
            console.log('Low contrast mode active:', isLowContrast);
            console.log('Body classes:', document.body.className);

            // Check if CSS variables are being applied
            const computedStyle = getComputedStyle(document.body);
            console.log('Current text-primary color:', computedStyle.getPropertyValue('--text-primary'));

            if (isLowContrast) {
                console.log('Low contrast mode should be active');
                // Force update CSS custom properties
                document.documentElement.style.setProperty('--text-primary', '#c0c0c0');
                document.documentElement.style.setProperty('--warning-yellow', '#b8a000');
            }
        }

        // Call this in your contrast toggle function
        contrastToggle.onclick = function() {
            const wasLowContrast = document.body.classList.contains('low-contrast');

            if (wasLowContrast) {
                document.body.classList.remove('low-contrast');
                localStorage.setItem('lowContrastEnabled', 'false');
            } else {
                document.body.classList.add('low-contrast');
                localStorage.setItem('lowContrastEnabled', 'true');
            }

            updateModeStatus();
            debugContrastMode(); // Add this line
        };


        
    </script>
</body>
</html>
